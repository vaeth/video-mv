#! /usr/bin/env sh
# (C) Martin V\"ath <martin@mvath.de>

Echo() {
	printf '%s\n' "${*}"
}

Fatal() {
	Echo "${0##*/}: ${*}" >&2
	trapret=2
	exit ${trapret}
}

Usage() {
	Echo "Usage: ${0##*/} [options] TIME
Sleep until TIME.  TIME must be understood by the 'date' utility.
Typical examples for TIME are:
	23:59
	'23:59:59 31 Dec 2012' (do not forget quoting from the shell)
options:
-T[pPfHsS-] pass option(s) to the title script; - means no title
-q  quiet
-h  show this help text"
	exit ${1:-1}
}

Title() {
Title() {
:
}
	case ${titleopt} in
	*-*)	return;;
	esac
	command -v title >/dev/null 2>&1 || return 0
TitleVerbose() {
:
}
	trapret=130
TitleTrap() {
	trap : EXIT HUP INT TERM
	TitleVerbose
	trap - EXIT HUP INT TERM
	exit ${trapret}
}
	trap TitleTrap EXIT HUP INT TERM
TitleInit() {
. title "${@}"
}
	TitleInit ${titleopt:+"-${titleopt}"} -- "${@}"
}

titleopt=
quiet=false
OPTIND=1
while getopts "T:qh?" opt
do	case ${opt} in
	T)	titleopt=${titleopt}${OPTARG};;
	q)	quiet=:;;
	*)	Usage 0;;
	esac
done
shift $(( ${OPTIND} - 1 ))
[ ${#} -gt 0 ] || Usage

case ${titleopt} in
*[!pPfHsS-]*)
	Usage;;
esac

curr=`date '+%s'` && [ -n "${curr:++}" ] || \
	Fatal 'cannot determine current date'
diff=`date -d "${*}" '+%s'` && [ -n "${diff:++}" ] || \
	Fatal 'cannot determine destination date'
[ "${diff}" -gt "${curr}" ] && diff=$(( ${diff} - ${curr} )) || diff=
if [ -z "${diff:++}" ]
then	Echo "not sleeping"
	exit 0
fi
if ! ${quiet}
then	if text=`date -d "${*}"` && [ -n "${text:++}" ]
	then	Echo "sleeping until ${text}"
		Title "zzz... ${text}"
	else	Echo "sleeping ${diff} seconds"
		Title "zzz... ${diff} sec"
	fi
fi
if [ -n "${trapret}" ]
then	sleep "${diff}"
	trapret=${?}
	TitleTrap
else	exec sleep "${diff}"
	Fatal 'failed to exec sleep ${diff}'
fi
